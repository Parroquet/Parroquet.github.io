<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ROP Emporium - ret2win | Parro </title> <meta name="author" content="Parro "> <meta name="description" content="ROP Emporium challenge 1 - ret2win"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%A1&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://parroquet.github.io/blog/2022/ret2win/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Parro </span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/hackthebox/">Hackthebox</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">ROP Emporium - ret2win</h1> <p class="post-meta">December 27, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/formatting"> <i class="fas fa-hashtag fa-sm"></i> formatting</a>   <a href="/blog/tag/links"> <i class="fas fa-hashtag fa-sm"></i> links</a>   <a href="/blog/tag/binexp"> <i class="fas fa-hashtag fa-sm"></i> binexp</a>     ·   <a href="/blog/category/rop"> <i class="fas fa-tag fa-sm"></i> ROP</a>   <a href="/blog/category/gdb"> <i class="fas fa-tag fa-sm"></i> GDB</a>   <a href="/blog/category/pwndbg"> <i class="fas fa-tag fa-sm"></i> pwndbg</a>   <a href="/blog/category/pwntools"> <i class="fas fa-tag fa-sm"></i> pwntools</a>   </p> </header> <article class="post-content"> <h2 id="basic-setup">Basic setup:</h2> <ul> <li>ROPEmporium x86 &amp; x86_64 binaries</li> <li>Ubuntu lab machine</li> <li>GDB &amp; pwndbg</li> <li>pwntools</li> </ul> <p> </p> <h3 id="link-to-challenge">Link to challenge</h3> <p><a href="https://ropemporium.com/challenge/ret2win.html" rel="external nofollow noopener" target="_blank">https://ropemporium.com/challenge/ret2win.html</a></p> <p> </p> <h3 id="the-32-bit-solve">The 32 bit solve</h3> <p>The first step for this binary is to run the <strong>file</strong> command to see what type of binary it is. We see that it is a 32 bit ELF binary. We then run the <strong>checksec</strong> command to see what protections are in place.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/1checksec.png" alt="checksec" width="750"></p> <p>As we can see in the above image, DEP/NX is enabled meaing that we cannot execute shellcode on the stack. We also see that partial RELRO is enabled which means that the the Global Offset Table (GOT) is read only. This means that we cannot overwrite any GOT entries.</p> <p>These protections should not be an issue as we only need to overwrite the return address to point to the ret2win function for the flag.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/3userdefinedfunctions.png" alt="definedfunctions" width="750"></p> <p>Using the nm command we can see user defined functions <strong>pwnme</strong> and <strong>ret2win</strong> along with their addresses which may be of interest to us.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/4strngs.png" alt="strngs" width="750"></p> <p>We can also run a basic <strong>strings</strong> command to find any interesting information. We can see the strings for when we run the program as well as the output message for the flag. It is seen to execute /bin/cat flag.txt aswell which is useful to know.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/5gdbdisas.png" alt="gdbdisas" width="750"></p> <p>Opening the program in gdb we can check the disassembly of each function. Looking at the ret2win function which is not called, we can see that system@plt is called with the argument /bin/cat flag.txt which is used to execute the command and output the flag. We need to call this function by overwriting a return address so that it redirects and executes the start of the ret2win function instead.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/6pwnme.png" alt="6pwnme" width="750"></p> <p>Disassembling the function shows us that <strong>push 0x20</strong> is executed to create a buffer of 32 bytes on the stack which is used to store the user input. If we overwrite this buffer with 32 bytes of rubbish and then overwrite the return address with the address of the ret2win function, we should be able to execute the ret2win function and get the flag.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/8addressesoffuncs.png" alt="8addressesoffuncs" width="750"></p> <p>Running the <strong>p &lt;function name&gt;</strong> command within gdb we can get the address of the ret2win function which we need to overwrite the return address with.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/9cylic.png" alt="9cylic" width="750"></p> <p>We can use the <strong>cyclic</strong> command to generate a string of 100 characters which we can use to overwrite the buffer. We can then enter this into the input field to crash the program.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/10findingcrashpoint.png" alt="10findingcrashpoint" width="750"></p> <p>Once the program crashes, we can look at the EIP register to see where the crash occured. We can see that the crash occured at 0x6161616c (laaa) which tells us the offset by looking back through the input string. The command <strong>cyclic -l laaa</strong> can be used to find the offset.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/11cyclicoffset.png" alt="11cyclicoffset" width="750"></p> <p>The offset is shown to be 44 bytes so we can overwrite the return address by adding the ret2win function address after this.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/15craftingpayloadwithreturnaddr.png" alt="15craftingpayloadwithreturnaddr" width="750"></p> <p>Using python3 we print 44 ‘A’ characters and then the address of the ret2win function in little endian format. We can then pipe this into the program and get the flag.</p> <p><code class="language-plaintext highlighter-rouge">python3 -c "import sys; sys.stdout.buffer.write(b'A'*44 + b'\x2c\86\x04\x08')" | ./ret2win32</code></p> <p> </p> <p><img src="../../../assets/img/ret2win_img/16craftedpayloadpython2.png" alt="16craftedpayloadpython2" width="750"></p> <p>Python2 can also be used to do this easier as python3 requires importing sys to output bytes and strings together. Here we print 44 NOP characters as a placeholder and add the return address in little endian format for the flag.</p> <p><code class="language-plaintext highlighter-rouge">python2 -c 'print "\x90"*44 + "\x2c\86\x04\x08"' | ./ret2win32</code></p> <p> </p> <h3 id="the-64-bit-solve">The 64 bit solve</h3> <p>The 64 bit binary is similar but we need to do a bit extra when looking at the offset.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/1764bitcyclic.png" alt="1764bitcyclic" width="750"></p> <p>After following the same steps, once we get to the cyclic generation, we can see a slightly different pattern generated due to 64 bit programs having a larger address space.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/18findingoffset.png" alt="18findingoffset" width="750"></p> <p>We can see that RIP has not got an string we can search for. This is because in a 64 bit architecture, an address is not returned to unless it resides within a range. Instead we can see the value of the RSP register which is the stack pointer. We can use this to find the offset. We can also use the last 4 bytes of the RBP and add 4 but I will tend to use the RSP method in future guides.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/19offsetfound.png" alt="19offsetfound" width="750"></p> <p>The offset is found to be 40 bytes. We can then craft the payload in the same way as before.</p> <p> </p> <p><img src="../../../assets/img/ret2win_img/20payloadbuiltandfinished.png" alt="20payloadbuiltandfinished" width="750"></p> <p>Using python2, we can again print 40 NOP characters followed by the little endian address of the ret2win function. \x00\x00\x00\x00 is then appended to the end to fit the length of 64 bit addresses. This returns us the flag.</p> <p><code class="language-plaintext highlighter-rouge">python2 -c 'print "\x90"*40 + "\x56\x07\x40\x00\x00\x00\x00\x00"' | ./ret2win</code></p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Parro . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>